name: Build and Package LetheLauncher

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ published ]

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write  # Required to create releases

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore LetheLauncher.sln --runtime win-x64

    - name: Build solution
      run: dotnet build LetheLauncher.sln --configuration Release --no-restore

    - name: Publish application
      run: dotnet publish LetheLauncher/LetheLauncher.csproj --configuration Release --runtime win-x64 --self-contained true --output ./publish

    - name: Create distribution package
      shell: powershell
      run: |
        # Create distribution directory
        mkdir -p ./publish/distribution

        # Copy main executable
        Copy-Item ./publish/LimbusCompany.exe ./publish/distribution/

        # Copy required native DLLs if they exist
        if (Test-Path ./publish/av_libglesv2.dll) { Copy-Item ./publish/av_libglesv2.dll ./publish/distribution/ }
        if (Test-Path ./publish/libHarfBuzzSharp.dll) { Copy-Item ./publish/libHarfBuzzSharp.dll ./publish/distribution/ }
        if (Test-Path ./publish/libSkiaSharp.dll) { Copy-Item ./publish/libSkiaSharp.dll ./publish/distribution/ }

        # List files in distribution
        Write-Host "Distribution package created:"
        Get-ChildItem ./publish/distribution/

    - name: Create distribution zip
      shell: powershell
      run: |
        # Create zip file containing all distribution files
        $zipPath = "./publish/LetheLauncher-Distribution-${{ github.run_number }}.zip"
        Compress-Archive -Path "./publish/distribution/*" -DestinationPath $zipPath

        # List the created zip file
        Write-Host "Created distribution zip:"
        Get-ChildItem $zipPath

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: LetheLauncher-Distribution-${{ github.run_number }}
        path: |
          ./publish/distribution/
          ./publish/LetheLauncher-Distribution-${{ github.run_number }}.zip
        if-no-files-found: error
        retention-days: 90

    - name: Create release assets
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        files: ./publish/LetheLauncher-Distribution-${{ github.run_number }}.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create pre-release on push to main
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: latest-build-${{ github.run_number }}
        name: Latest Build (${{ github.run_number }})
        body: |
          ðŸš€ **Automatic build from latest commit**

          This is an automated build of the latest changes. For stable releases, check the Releases section.

          **ðŸ“¦ Download (ZIP):**
          - Download `LetheLauncher-Distribution-${{ github.run_number }}.zip`
          - Contains the launcher executable and all required DLLs
          - Extract and run `LimbusCompany.exe` to use

          **Changes in this build:**
          - Built from commit: ${{ github.sha }}
          - Build number: ${{ github.run_number }}
        files: ./publish/LetheLauncher-Distribution-${{ github.run_number }}.zip
        prerelease: true
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
